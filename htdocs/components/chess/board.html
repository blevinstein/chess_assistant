<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-xhr.html">

<polymer-element name="chess-board">
  <template>
    <style>
      table {
        border: 5px solid black;
        border-spacing: 0;
      }
      tr {
        height: 80px;
      }
      td {
        text-align: center;
        font-size: 60px;
        width: 80px;
      }
    </style>
    <core-xhr id="xhr"></core-xhr>
    <table>
      <template repeat="{{ rank in range(N) }}">
        <tr>
          <template repeat="{{ file in range(N) }}">
          <td style="background-color:{{ getColor(file, rank) }}"
              rank="{{rank}}"
              file="{{file}}"
              on-click="{{handleClick}}">
            {{ positionRef(position, [file, rank]).repr }}
            </td>
          </template>
        </tr>
      </template>
    </table>
  </template>
  <script>

    Polymer({
      lit: [ ], // TODO generalize (layers?)
      position: [ ],
      N: 8,

      // convenience function: equality for locations
      eq: function(loca, locb) {
        return loca[0] == locb[0] && loca[1] == locb[1];
      },

      // convenience function: array contains for locations
      cont: function(arr, loc) {
        for (var i = 0; i < arr.length; i++) {
          if (this.eq(arr[i], loc)) { return true; }
        }
        return false;
      },

      getColor: function (file, rank) {
        if (this.cont(this.lit, [file, rank])) { return "#0f0"; }
        // else return black/white checkerboard
        if ((file + rank) % 2 == 0) {
          return "#bbb";
        } else {
          return "#777";
        }
      },

      setPosition: function(newPosition) {
        // TODO re-examine how this updates, try to trigger refresh
        this.position = newPosition;
      },

      positionRef: function(position, loc) {
        var self = this;
        return position.filter(function (elem) {
            return self.eq(elem.loc, loc);
        })[0];
      },

      range: function (n) {
        var arr = [];
        for (var i = 0; i < n; i++) {
          arr.push(i);
        }
        return arr;
      },

      ready: function () {
        var self = this;

        // get a new board
        this.$.xhr.request({url: "/new-board", callback: function (resp) {
            self.setPosition(JSON.parse(resp));
          }});
      },

      refresh: function () {
        var self = this;
        // HACK changes N to force update
        self.N = 0;
        setTimeout(function () { self.N = 8; }, 1);
      },

      handleClick: function(e) {
        // check that this is an element we care about
        if (e.toElement.tagName != "TD") { return; }

        var loc = [parseInt(e.toElement.getAttribute("file")),
            parseInt(e.toElement.getAttribute("rank"))];
        this.getMoves(loc);
      },

      getMoves: function(loc) {
        var self = this;

        var params = {
          loc: loc,
          position: this.position
        };

        if (this.positionRef(this.position, params.loc) == null) {
          return; // square is empty
        }

        this.$.xhr.request({
          body: JSON.stringify(params),
          method: "post",
          url: "/moves",
          callback: function (resp) {
            // check for exception dumps from server
            if (resp[0] == "#") { console.log(resp); return; }

            // lit = the destinations of all moves
            self.lit = [];
            JSON.parse(resp).forEach(function (move) {
                self.lit.push(move[1]);
              });
            self.refresh();
          }});
      },
    });
  </script>
</polymer-element>
