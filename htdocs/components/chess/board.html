<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-xhr.html">

<polymer-element name="chess-board">
  <template>
    <style>
      table {
        border: 5px solid black;
        border-spacing: 0;
      }
      tr {
        height: 80px;
      }
      td {
        text-align: center;
        font-size: 60px;
        width: 80px;
      }
    </style>
    <core-xhr id="xhr"></core-xhr>
    <table>
      <template repeat="{{ rank in range(grid.length) }}">
        <tr>
          <template repeat="{{ file in range(grid[rank].length) }}">
          <td style="background-color:{{ getColor(file, rank) }}"
              rank="{{rank}}"
              file="{{file}}"
              on-click="{{handleClick}}">
            {{ grid[rank][file].repr }}
            </td>
          </template>
        </tr>
      </template>
    </table>
  </template>
  <script>

    Polymer({
      grid: [ ], // TODO rm
      lit: [ ], // TODO generalize (layers?)
      position: [ ],

      getColor: function (file, rank) {
        // if [file,rank] in lit, return green
        for (var i = 0; i < this.lit.length; i++) {
          if (this.lit[i][0] == file && this.lit[i][1] == rank) { return "#0f0"; }
        }
        // else return black/white checkerboard
        if ((file + rank) % 2 == 0) {
          return "#bbb";
        } else {
          return "#777";
        }
      },

      // TODO rm
      setGrid: function (newGrid) {
        this.grid = newGrid;
      },

      setPosition: function(newPosition) {
        // TODO re-examine how this updates, try to trigger refresh
        this.position = newPosition;
      },

      positionRef: function(position, loc) {
        return position.filter(function (elem) {
            return elem.loc == loc;
        })[0];
      },

      range: function (n) {
        var arr = [];
        for (var i = 0; i < n; i++) {
          arr.push(i);
        }
        return arr;
      },

      ready: function () {
        var self = this;

        // get a new board
        this.$.xhr.request({url: "/new-board", callback: function (resp) {
            //self.setPosition(JSON.parse(resp));
            self.setGrid(JSON.parse(resp));
          }});
      },

      // TODO change to use position
      refresh: function () {
        var self = this;
        // HACK deletes and replaces grid to trigger refresh
        var tmp = self.grid;
        self.grid = [];
        setTimeout(function () { self.grid = tmp; }, 1);
      },

      handleClick: function(e) {
        var self = this;
        // HACK check that this is an element we care about
        if (e.toElement.tagName != "TD") { return; }

        var params = {
          rank: e.toElement.getAttribute("rank"),
          file: e.toElement.getAttribute("file"),
          grid: this.grid
        };

        // TODO only send request if square is not empty
        this.$.xhr.request({
          body: JSON.stringify(params),
          method: "post",
          url: "/moves",
          callback: function (resp) {
            if (resp[0] == "#") { console.log(resp); return; }
            self.lit = [];
            JSON.parse(resp).forEach(function (move) {
                self.lit.push(move[1]);
              });
            self.refresh();
          }});
      },
    });
  </script>
</polymer-element>
